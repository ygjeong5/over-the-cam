pipeline {
    agent any


    environment {
       DOCKERHUB_CREDENTIALS = credentials('docker')
       DOCKER_IMAGE_BACKEND = 'ghkdtnql/overthecam-backend'
    }

    stages {
        stage('Build BE') {
            steps {
              dir('feontend/overthecam') {
                  sh '''
                      chmod +x gradlew
                      rm -rf build
                      ./gradlew clean build -x test
                  '''
              }
            }
        }
        stage('Docker Build & Push') {
            steps {
              script {
                  dir('backend/overthecam') {
                      sh """
                          docker build -t ${DOCKER_IMAGE_BACKEND}:${BUILD_NUMBER} .
                          echo $DOCKERHUB_CREDENTIALS_PSW | docker login -u $DOCKERHUB_CREDENTIALS_USR --password-stdin
                          docker push ${DOCKER_IMAGE_BACKEND}:${BUILD_NUMBER}
                      """
                  }
              }
            }
        }
        stage('Deploy to EC2') {
          steps {
              sshagent(['ssh']) {
                  sh """
                      ssh -o StrictHostKeyChecking=no ubuntu@i12d204.p.ssafy.io '
                          # Backend
                          docker pull ${DOCKER_IMAGE_BACKEND}:${BUILD_NUMBER}
                          docker stop backend || true
                          docker rm backend || true
                          docker run -d --name backend -p 8080:8080 ${DOCKER_IMAGE_BACKEND}:${BUILD_NUMBER}

                          # Frontend
                          docker pull ${DOCKER_IMAGE_FRONTEND}:${BUILD_NUMBER}
                          docker stop frontend || true
                          docker rm frontend || true
                          docker run -d --name frontend -p 5173:80 ${DOCKER_IMAGE_FRONTEND}:${BUILD_NUMBER}
                      '
                  """
              }
          }
        }
    }
}